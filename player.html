<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- polyfill -->
    <script src="MIDI.js/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="MIDI.js/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="MIDI.js/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="MIDI.js/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="MIDI.js/js/midi/gm.js" type="text/javascript"></script>
    <script src="MIDI.js/js/midi/loader.js" type="text/javascript"></script>
    <script src="MIDI.js/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="MIDI.js/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="MIDI.js/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="MIDI.js/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="MIDI.js/js/util/dom_request_script.js" type="text/javascript"></script>
    <style>
        .player-container {
            background-color: lightblue;
            height: 60px;
            width: 100%;
            box-sizing: border-box;
            border: solid black 1px;
            display: flex;
        }

        .Â§tainer {
            background-color: lightblue;
            height: 60px;
            width: 100%;
            box-sizing: border-box;
            border: solid black 1px;
            display: flex;
        }

        div.player-note {
            display: flex;
            width: 100%;
            height: 100%;
            background-color: pink;
            border: 1px solid gray;
            box-sizing: border-box;
        }

        .drums-container > div.player-note {
            background-color: orange;
        }

        div.player-note[data-play="play"] {
            background-color: blue;
        }

        div.current-note {
            border: 2px solid red;
        }

        div.note-letter {
            position: absolute;
            left: 10px;
        }
    </style>
</head>
<body>
<div id="player">
    <div id="player-controls">
        <label for="play-speed">
            <input type="number" id="play-speed">
            Play Speed:
        </label>
        <button id="add-column">Add Column</button>
        <button id="delete-column">Delete Column</button>
        <button id="pause-play" data-action="pause">Pause</button>
    </div>
</div>
<script type="text/javascript">
    window.onload = function () {

//        MIDI.setVolume(0, 127);
//        MIDI.noteOn(0, 50, 127, 0);
//        MIDI.noteOff(0, 50, 0.75);
        var maxNotes = 20;
        var speed = 300;
        var loop;
        var instruments = {piano: '', drums: ''};
        var instrumentsToLoad = 1;


        function playNote(instrument, pitch) {
            MIDI.setVolume(0, 127);
            MIDI.noteOn(0, pitch, 127, 0);
            MIDI.noteOff(0, pitch, 0.75);
        }

        function changespeed(newspeed) {
            speed = newspeed
        }

        function start() {
            loadBoards()
            bindNoteCellClicks()
            bindControls()
            mainLoop(0)
        }

        function bindControls() {
            let playBoards = $('div.player-container')
            let playSpeed = $('#play-speed')
            playSpeed.val(speed)
            playSpeed.on('change', function () {
                changespeed($(this).val())
            })

            $('#add-column').on('click', function () {
                playBoards.each(function () {
                    let noteCell = $('<div class="player-note">')
                    $(noteCell).on('click', function () {
                        if ($(this).attr('data-play') === "play") {
                            $(this).removeAttr('data-play')
                        } else {
                            $(this).attr('data-play', 'play')
                        }
                    })
                    $(this).append(noteCell)
                    maxNotes = $(playBoards.get(0)).children().length
                })
            })

            $('#delete-column').on('click', function () {
                playBoards.each(function () {
                    $(this).children(':last-child').remove()
                    maxNotes = $(playBoards.get(0)).children().length
                })
            })

            $('#pause-play').on('click', function () {
                if ($(this).attr('data-action') === 'pause') {
                    clearTimeout(loop);
                    $(this).text('Play')
                    $(this).attr('data-action', 'play')
                } else {
                    mainLoop(0)
                    $(this).text('Pause')
                    $(this).attr('data-action', 'pause')
                }
            })
        }

        function mainLoop(note) {           //  create a loop function
            console.log('loop' + note)
            loop = setTimeout(function () {    //  call a 3s setTimeout when the
                note = (note >= maxNotes) ? 0 : note;
                let playBoards = $('.player-container')
                let drumBoards = $('.drums-container');

                playBoards.each(function () {
                    let noteCells = $(this).children('.player-note')
                    let currentNote = $(noteCells.get(note))
                    noteCells.removeClass('current-note')
                    currentNote.addClass('current-note')

                    if (currentNote.attr('data-play') === "play") {
                        console.log('play piano')
                        playNote(instruments.piano, $(this).attr('data-pitch'))
                    }
                })

                drumBoards.each(function () {
                    let noteCells = $(this).children('.player-note')
                    let currentNote = $(noteCells.get(note))
                    noteCells.removeClass('current-note')
                    currentNote.addClass('current-note')

                    if (currentNote.attr('data-play') === "play") {
                        console.log('play drums')
                        playNote(instruments.drums, $(this).attr('data-pitch'))
                    }
                })
                mainLoop(++note);
            }, speed)
        }

        function loadBoards() {
            let notes = [50, 52, 54, 55, 57, 59, 61]
            notes.reverse()
            let noteLetters = ['c', 'd', 'e', 'f', 'g', 'a', 'b']
            noteLetters.reverse()

            for (let i = 0; i < 10; i++) {
                let pitch = notes[i % notes.length] - (13 * Math.floor(i / notes.length));
                console.log('adding note with pitch ' + pitch)
                let noteLetter = $('<div class="note-letter">')
                noteLetter.text(noteLetters[i % notes.length])

                let playBoard = $(`<div class="player-container" data-pitch="${pitch}">`)
                playBoard.append(noteLetter)

                $('div#player').append(playBoard)
            }

//            for (let i = 0; i < 10; i++) {
//                let pitch = notes[i % notes.length] + (13 * Math.floor(i / notes.length));
//                console.log('adding note with pitch ' + pitch)
//                let noteLetter = $('<div class="note-letter">')
//                noteLetter.text(noteLetters[i % notes.length])
//
//                let playBoard = $(`<div class="drums-container" data-pitch="${pitch}">`)
//                playBoard.append(noteLetter)
//
//                $('div#player').append(playBoard)
//            }

            let playBoards = $('div.player-container')

            playBoards.each(function () {
                for (let i = 0; i < maxNotes; i++) {
                    let noteCell = $('<div class="player-note">')
                    $(this).append(noteCell)
                }
            })

            let drumBoards = $('div.drums-container')
            drumBoards.each(function () {
                for (let i = 0; i < maxNotes; i++) {
                    let noteCell = $('<div class="player-note">')
                    $(this).append(noteCell)
                }
            })
        }


        function bindNoteCellClicks() {
            let noteCells = $('div.player-note')

            noteCells.each(function (index, note) {
                $(note).on('click', function () {
                    if ($(this).attr('data-play') === "play") {
                        $(this).removeAttr('data-play')
                    } else {
                        $(this).attr('data-play', 'play')
                    }
                })
            })
        }

        function registerLoadedInstrument() {
            console.log('register')
            instrumentsToLoad--;
            if (instrumentsToLoad <= 0) {
                console.log('loaded instruments')
                start()
//                function loop(count) {
//                    setTimeout(function () {
//                            console.log(count)
//                            instruments.drums.setVolume(0, 127);
//                            instruments.drums.noteOn(0, count, 127, 0);
//                            instruments.drums.noteOff(0, count, 0.75);
//                            if (--count) {
//                                loop(count)
//                            }
//                    }, 500)
//                }
//
//                loop(100)
            }
        }

        function loadDrums(url, instrument) {
            MIDI.loadPlugin({
                soundfontUrl: url,
                instrument: instrument,
                onsuccess: function () {
                    instruments.drums = MIDI
                    registerLoadedInstrument()
                }
            });
        }

        function loadPiano(url, instrument) {
            MIDI.loadPlugin({
                soundfontUrl: url,
                instrument: instrument,
                onsuccess: function () {
//                    instruments.piano = MIDI
                    registerLoadedInstrument()
                }
            });
        }

                loadPiano("MIDI.js/examples/soundfont/", "acoustic_grand_piano")
//        loadDrums("MIDI.js/examples/soundfont/", "synth_drum")
    }
    ;
</script>
</body>
</html>